<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crystal Patterns</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <style>
        #gameBoard { display: grid; grid-template-columns: repeat(9, 30px); gap: 2px; margin: 20px auto; }
        .cell { width: 30px; height: 30px; background: #eee; border: 1px solid #ccc; }
        .player1 { background: rgba(255, 0, 0, 0.3); }
        .player2 { background: rgba(0, 0, 255, 0.3); }
        .pattern-card { width: 90px; height: 90px; display: grid; grid-template-columns: repeat(3, 1fr); margin: 5px; border: 2px solid #000; }
        .pattern-cell { width: 30px; height: 30px; }
        .matched { opacity: 0.5; }
        .current-player { border-color: green; }
        .modal-content { text-align: center; }
    </style>
</head>
<body>

<div class="container">
    <h2>Crystal Patterns</h2>
    <div id="playerIndicator" class="mb-3">
        <span id="player1Indicator" class="badge bg-danger current-player">Player 1</span>
        <span id="player2Indicator" class="badge bg-primary">Player 2</span>
    </div>
    <div id="gameBoard"></div>
    <div id="patterns">
        <div id="player1Patterns"></div>
        <div id="player2Patterns"></div>
    </div>
    <button id="restart" class="btn btn-warning">Restart Game</button>
</div>

<div class="modal fade" id="winModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body">
                <h5>Congratulations!</h5>
                <p id="winMessage"></p>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    $(document).ready(function() {
        const board = $('#gameBoard');
        const patterns = {
            player1: [],
            player2: []
        };
        let currentPlayer = 'player1';
        const patternLibrary = [
            [[1,1,1],[0,1,0],[0,0,0]],
            [[0,1,0],[1,1,1],[0,1,0]],
            // Add more patterns here
        ];

        function initializeGame() {
            for(let i = 0; i < 81; i++) {
                board.append(`<div class="cell" data-index="${i}"></div>`);
            }
            generatePatterns();
            updateDisplay();
        }

        function generatePatterns() {
            for (let player in patterns) {
                patterns[player] = [];
                for(let i = 0; i < 3; i++) {
                    let randomPattern = patternLibrary[Math.floor(Math.random() * patternLibrary.length)];
                    patterns[player].push(JSON.parse(JSON.stringify(randomPattern))); // Deep copy
                }
            }
        }

        function updateDisplay() {
            $('.cell').removeClass('player1 player2');
            $('#playerIndicator span').removeClass('current-player');
            $(`#${currentPlayer}Indicator`).addClass('current-player');
            displayPatterns();
        }

        function displayPatterns() {
            for (let player in patterns) {
                let playerDiv = $(`#${player}Patterns`);
                playerDiv.empty();
                patterns[player].forEach((pattern, index) => {
                    let patternDiv = $('<div class="pattern-card">');
                    if (pattern.matched) patternDiv.addClass('matched');
                    patternDiv.css('border-color', player === 'player1' ? 'red' : 'blue');
                    for(let i = 0; i < 3; i++) {
                        for(let j = 0; j < 3; j++) {
                            let cell = $('<div class="pattern-cell">');
                            if(pattern[i][j]) cell.css('background', player === 'player1' ? 'red' : 'blue');
                            patternDiv.append(cell);
                        }
                    }
                    playerDiv.append(patternDiv);
                });
            }
        }

        function checkPatterns() {
            let playerPatterns = patterns[currentPlayer];
            board.children().each(function() {
                let index = $(this).data('index');
                playerPatterns.forEach(pattern => {
                    if (!pattern.matched && checkPatternAt(index, pattern)) {
                        pattern.matched = true;
                    }
                });
            });

            let matchedCount = playerPatterns.filter(p => p.matched).length;
            if (matchedCount >= 2) {
                $('#winMessage').text(`${currentPlayer === 'player1' ? 'Player 1' : 'Player 2'} wins!`);
                $('#winModal').modal('show');
            }
        }

        function checkPatternAt(index, pattern) {
            // Implement pattern checking logic here
            // This is a simplified example:
            for(let i = 0; i < 3; i++) {
                for(let j = 0; j < 3; j++) {
                    if(pattern[i][j]) {
                        let boardIndex = index + (i * 9) + j;
                        if(boardIndex >= 81 || boardIndex < 0 ||
                            !$('.cell').eq(boardIndex).hasClass(currentPlayer)) {
                            return false;
                        }
                    }
                }
            }
            return true;
        }

        $('#restart').on('click', function() {
            initializeGame();
        });

        board.on('click', '.cell', function() {
            if (!$(this).hasClass('player1') && !$(this).hasClass('player2')) {
                $(this).addClass(currentPlayer);
                checkPatterns();
                currentPlayer = currentPlayer === 'player1' ? 'player2' : 'player1';
                updateDisplay();
            }
        });

        initializeGame();
    });
</script>
</body>
</html>