<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Crystal Patterns</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #gameBoard {
            width: 450px;
            height: 450px;
            margin: auto;
        }
        .cell {
            width: 50px;
            height: 50px;
            border: 1px solid #ccc;
            display: inline-block;
            cursor: pointer;
        }
        .red { background-color: rgba(255, 0, 0, 0.7); }
        .blue { background-color: rgba(0, 0, 255, 0.7); }
        .pattern-card {
            width: 150px;
            height: 150px;
            border: 2px solid transparent;
            opacity: 0.5;
        }
        .matched { opacity: 0.2; }
        .current-player { border-color: yellow; }
        .modal-content { text-align: center; }
    </style>
</head>
<body>

<div class="container">
    <h2>Crystal Patterns</h2>
    <div id="playerInfo" class="mb-3">
        <span id="player1" class="badge badge-danger">Player 1</span>
        <span id="player2" class="badge badge-primary">Player 2</span>
        <span id="currentPlayer" class="ml-3"></span>
    </div>
    <div id="gameBoard"></div>
    <div id="patterns"></div>
    <button id="restartButton" class="btn btn-secondary">Restart</button>
</div>

<div class="modal fade" id="winModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-body" id="winMessage"></div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script>
    const boardSize = 9;
    let gameBoard = Array(boardSize * boardSize).fill(0);
    let playerPatterns = {1: [], 2: []};
    let currentPlayer = 1;
    let scores = {1: 0, 2: 0};

    function initPatterns() {
        for (let p = 1; p <= 2; p++) {
            for (let i = 0; i < 3; i++) {
                let pattern = [];
                while(pattern.length < 5) {
                    let pos = Math.floor(Math.random() * 9);
                    if (!pattern.includes(pos)) pattern.push(pos);
                }
                playerPatterns[p].push(pattern);
            }
        }
    }

    function drawBoard() {
        const boardDiv = document.getElementById('gameBoard');
        boardDiv.innerHTML = '';
        for (let i = 0; i < boardSize * boardSize; i++) {
            let cell = document.createElement('div');
            cell.className = 'cell';
            cell.onclick = () => placePiece(i);
            boardDiv.appendChild(cell);
        }
    }

    function drawPatterns() {
        const patternsDiv = document.getElementById('patterns');
        patternsDiv.innerHTML = '';
        for (let player in playerPatterns) {
            playerPatterns[player].forEach((pattern, index) => {
                let card = document.createElement('div');
                card.className = 'pattern-card';
                pattern.forEach(pos => {
                    let cell = document.createElement('div');
                    cell.className = 'cell ' + (player == 1 ? 'red' : 'blue');
                    cell.style.opacity = '0.3';
                    card.appendChild(cell);
                });
                patternsDiv.appendChild(card);
            });
        }
    }

    function placePiece(index) {
        if (gameBoard[index] === 0) {
            gameBoard[index] = currentPlayer;
            checkPatterns(currentPlayer);
            currentPlayer = currentPlayer === 1 ? 2 : 1;
            updateDisplay();
        }
    }

    function checkPatterns(player) {
        let matchedPatterns = 0;
        playerPatterns[player].forEach((pattern, patternIndex) => {
            if (pattern.every(pos => gameBoard[pos] === player)) {
                matchedPatterns++;
                // Dim the matched pattern
                document.querySelectorAll('.pattern-card')[patternIndex + (player-1)*3].classList.add('matched');
            }
        });
        if (matchedPatterns >= 2) {
            document.getElementById('winMessage').innerText = `Player ${player} wins!`;
            $('#winModal').modal('show');
        }
    }

    function updateDisplay() {
        const cells = document.getElementsByClassName('cell');
        for (let i = 0; i < cells.length; i++) {
            cells[i].className = 'cell ' + (gameBoard[i] === 1 ? 'red' : gameBoard[i] === 2 ? 'blue' : '');
        }
        document.getElementById('currentPlayer').innerText = `Current: Player ${currentPlayer}`;
        document.getElementById('player' + currentPlayer).classList.add('current-player');
        // Reset highlight for previous player
        document.getElementById('player' + (currentPlayer === 1 ? 2 : 1)).classList.remove('current-player');
    }

    function restartGame() {
        gameBoard = Array(boardSize * boardSize).fill(0);
        playerPatterns = {1: [], 2: []};
        currentPlayer = 1;
        initPatterns();
        drawBoard();
        drawPatterns();
        updateDisplay();
        $('#winModal').modal('hide');
    }

    document.getElementById('restartButton').addEventListener('click', restartGame);
    initPatterns();
    drawBoard();
    drawPatterns();
    updateDisplay();
</script>

</body>
</html>