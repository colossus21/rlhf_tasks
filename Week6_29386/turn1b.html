<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Gravity Battle</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.17.1/matter.min.js"></script>
    <style>
        body {
            background: #1a1a1a;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            font-family: Arial, sans-serif;
        }
        canvas {
            border: 4px solid #00bfff;
            box-shadow: 0 0 20px #00bfff;
        }
        #ui {
            position: absolute;
            width: 800px;
            color: white;
        }
        .player-info {
            position: absolute;
            top: 10px;
        }
        #player1-info { left: 10px; }
        #player2-info { right: 10px; }
        .bar {
            height: 10px;
            margin-top: 5px;
        }
        .health { background: green; }
        .special { background: yellow; }
        #restart {
            display: none;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            padding: 10px 20px;
            font-size: 18px;
            cursor: pointer;
        }
    </style>
</head>
<body>
<div id="ui">
    <div id="player1-info" class="player-info">
        <div>Player 1 (Blue)</div>
        <div class="bar health" id="p1-health"></div>
        <div class="bar special" id="p1-special"></div>
    </div>
    <div id="player2-info" class="player-info">
        <div>Player 2 (Red)</div>
        <div class="bar health" id="p2-health"></div>
        <div class="bar special" id="p2-special"></div>
    </div>
    <button id="restart">Restart Game</button>
</div>
<script>
    const { Engine, Render, Runner, World, Bodies, Body, Events } = Matter;

    const width = 800;
    const height = 600;
    const engine = Engine.create();
    const render = Render.create({
        element: document.body,
        engine: engine,
        options: {
            width: width,
            height: height,
            wireframes: false,
            background: '#222'
        }
    });

    // Players
    const player1 = Bodies.rectangle(100, 300, 50, 50, { frictionAir: 0.05, label: 'player1', color: '#0000FF' });
    const player2 = Bodies.rectangle(700, 300, 50, 50, { frictionAir: 0.05, label: 'player2', color: '#FF0000' });

    // Ground and Spikes
    const ground = Bodies.rectangle(width / 2, height + 25, width, 50, { isStatic: true, angle: Math.PI });
    const ceiling = Bodies.rectangle(width / 2, -25, width, 50, { isStatic: true });
    const spikes = [
        Bodies.polygon(width / 2, height / 2, 3, 50, { isStatic: true, angle: Math.PI, label: 'spikes', color: '#00FF00' }),
        // Add more spikes here if needed
    ];

    // Power-ups
    let powerUps = [];

    const wallOptions = { isStatic: true };
    const walls = [
        Bodies.rectangle(0, height / 2, 1, height, wallOptions), // Left
        Bodies.rectangle(width, height / 2, 1, height, wallOptions) // Right
    ];

    World.add(engine.world, [player1, player2, ground, ceiling, ...spikes, ...walls]);

    // Controls
    const keys = { w: false, a: false, s: false, d: false, ArrowUp: false, ArrowDown: false, ArrowLeft: false, ArrowRight: false };
    document.addEventListener('keydown', (e) => keys[e.key] = true);
    document.addEventListener('keyup', (e) => keys[e.key] = false);

    // Game logic
    let gravityDirection = 1;
    const jumpForce = 0.005;
    const moveForce = 0.001;
    const maxHealth = 100;
    let health = { player1: maxHealth, player2: maxHealth };
    let specialMeter = { player1: 0, player2: 0 };

    Events.on(engine, 'collisionStart', event => {
        const pairs = event.pairs;
        for (let pair of pairs) {
            let labels = [pair.bodyA.label, pair.bodyB.label];
            if (labels.includes('spikes') && (labels.includes('player1') || labels.includes('player2'))) {
                const player = labels.includes('player1') ? 'player1' : 'player2';
                health[player] -= 10;
                if (health[player] <= 0) {
                    alert((player === 'player1' ? 'Player 2' : 'Player 1') + ' Wins!');
                    document.getElementById('restart').style.display = 'block';
                }
            }
            if (labels.includes('powerUp') && (labels.includes('player1') || labels.includes('player2'))) {
                const player = labels.includes('player1') ? 'player1' : 'player2';
                health[player] = Math.min(health[player] + 20, maxHealth);
                specialMeter[player] = Math.min(specialMeter[player] + 30, 100);
                World.remove(engine.world, pair.bodyB);
                powerUps = powerUps.filter(p => p !== pair.bodyB);
            }
        }
    });

    function spawnPowerUp() {
        if (Math.random() < 0.02) { // 2% chance each frame
            const x = Math.random() * width;
            const y = Math.random() * height;
            const powerUp = Bodies.circle(x, y, 10, { label: 'powerUp', isStatic: true, render: { fillStyle: '#FF69B4' } });
            powerUps.push(powerUp);
            World.add(engine.world, powerUp);
        }
    }

    Runner.run(engine);
    Render.run(render);

    (function update() {
        const { w, a, s, d, ArrowUp, ArrowDown, ArrowLeft, ArrowRight } = keys;

        // Player 1 controls
        if (a) Body.applyForce(player1, {x: player1.position.x, y: player1.position.y}, {x: -moveForce, y: 0});
        if (d) Body.applyForce(player1, {x: player1.position.x, y: player1.position.y}, {x: moveForce, y: 0});
        if (w && gravityDirection === 1) Body.applyForce(player1, player1.position, {x: 0, y: -jumpForce});
        if (s && specialMeter.player1 >= 100) {
            gravityDirection *= -1;
            engine.world.gravity.y *= -1;
            specialMeter.player1 = 0;
        }

        // Player 2 controls
        if (ArrowLeft) Body.applyForce(player2, {x: player2.position.x, y: player2.position.y}, {x: -moveForce, y: 0});
        if (ArrowRight) Body.applyForce(player2, {x: player2.position.x, y: player2.position.y}, {x: moveForce, y: 0});
        if (ArrowUp && gravityDirection === 1) Body.applyForce(player2, player2.position, {x: 0, y: -jumpForce});
        if (ArrowDown && specialMeter.player2 >= 100) {
            gravityDirection *= -1;
            engine.world.gravity.y *= -1;
            specialMeter.player2 = 0;
        }

        // If gravity is flipped, players can jump from the ceiling
        if (gravityDirection === -1) {
            if (w) Body.applyForce(player1, player1.position, {x: 0, y: jumpForce});
            if (ArrowUp) Body.applyForce(player2, player2.position, {x: 0, y: jumpForce});
        }

        // Update UI
        document.getElementById('p1-health').style.width = `${health.player1}%`;
        document.getElementById('p1-special').style.width = `${specialMeter.player1}%`;
        document.getElementById('p2-health').style.width = `${health.player2}%`;
        document.getElementById('p2-special').style.width = `${specialMeter.player2}%`;

        spawnPowerUp();

        requestAnimationFrame(update);
    })();

    document.getElementById('restart').onclick = function() {
        location.reload();
    };
</script>
</body>
</html>