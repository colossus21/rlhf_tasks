<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connect 4 with a Twist</title>
    <style>
        body {
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #282c34;
        }
        canvas {
            display: block;
        }
    </style>
</head>
<body>

<script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js"></script>
<script>
    const config = {
        type: Phaser.AUTO,
        width: 600,
        height: 600,
        backgroundColor: '#282c34',
        scene: {
            preload: preload,
            create: create,
            update: update
        },
        audio: {
            disableWebAudio: false
        }
    };

    const ROWS = 6;
    const COLS = 7;
    const WINNING_SCORE = 3;
    let grid = [];
    let currentPlayer = 1;
    let player1Score = 0;
    let player2Score = 0;
    let gameOver = false;
    let highlightedColumn = -1;
    let bgMusic;

    const game = new Phaser.Game(config);

    function preload() {
        this.load.audio('tick', ['tick.wav']); // Ensure you have this sound file
        this.load.audio('bg', ['bg.wav']); // Background music
    }

    function create() {
        grid = [];
        createBoard(this);

        // Play background music
        bgMusic = this.sound.add('bg', { loop: true });
        bgMusic.play();

        this.input.on('pointerdown', (pointer) => {
            if (!gameOver) {
                handlePointerDown(pointer, this);
            }
        });

        // Score texts
        this.add.text(0, 10, 'Player 1 (Red): 0', { fontSize: '20px', fill: '#fff' }).setName('player1Score');
        this.add.text(280, 10, 'Player 2 (Yellow): 0', { fontSize: '20px', fill: '#fff' }).setName('player2Score');
    }

    function update() {
        // Update logic if necessary
    }

    function createBoard(scene) {
        const cellSize = 75;
        const startX = (config.width - (COLS * cellSize)) / 2;
        const startY = (config.height - (ROWS * cellSize)) / 2;

        for (let row = 0; row < ROWS; row++) {
            grid[row] = [];
            for (let col = 0; col < COLS; col++) {
                // Create circular tokens instead of rectangles
                const circle = scene.add.circle(startX + col * cellSize + cellSize/2, startY + row * cellSize + cellSize/2, cellSize/2 - 5, 0xffffff);
                circle.setStrokeStyle(2, 0x000000);
                circle.setInteractive();

                // Hover effect for circular tokens
                circle.on('pointerover', () => {
                    if (!gameOver && grid[row][col].player === 0) {
                        highlightColumn(col, 0xffe4b5);
                    }
                });
                circle.on('pointerout', () => unhighlightColumn(col));

                grid[row][col] = {
                    cell: circle,
                    player: 0
                };
            }
        }
    }

    // Modify existing functions to handle circular tokens, sound effects, and game end conditions:

    function handlePointerDown(pointer, scene) {
        if (highlightedColumn !== -1) {
            const sound = scene.sound.add('tick');
            for (let row = ROWS - 1; row >= 0; row--) {
                if (grid[row][highlightedColumn].player === 0) {
                    grid[row][highlightedColumn].player = currentPlayer;
                    grid[row][highlightedColumn].cell.setFillStyle(currentPlayer === 1 ? 0xff0000 : 0xffff00);
                    sound.play();
                    // ... rest of your logic for checking win, etc.
                    if (isBoardFull() || player1Score === WINNING_SCORE || player2Score === WINNING_SCORE) {
                        endGame(scene);
                    }
                    return;
                }
            }
        }
    }

    function isBoardFull() {
        return grid.every(row => row.every(cell => cell.player !== 0));
    }

    function endGame(scene) {
        gameOver = true;
        bgMusic.stop(); // Stop background music

        let message = '';
        if (player1Score > player2Score) message = 'Player 1 Wins!';
        else if (player2Score > player1Score) message = 'Player 2 Wins!';
        else message = 'It\'s a Tie!';

        // Display end game message
        scene.add.rectangle(config.width / 2, config.height / 2, 400, 100, 0x000000).setOrigin(0.5).setAlpha(0.8);
        scene.add.text(config.width / 2, config.height / 2, message, { fontSize: '48px', fill: '#fff' }).setOrigin(0.5);
        // Add restart instructions
    }

    // Ensure to update highlight/unhighlight functions to work with circles
    function highlightColumn(col, color) {
        for (let row = 0; row < ROWS; row++) {
            if (grid[row][col].player === 0) {
                grid[row][col].cell.setFillStyle(color);
            }
        }
    }

    function unhighlightColumn(col) {
        for (let row = 0; row < ROWS; row++) {
            if (grid[row][col].player === 0) {
                grid[row][col].cell.setFillStyle(0xffffff);
            }
        }
    }

</script>

</body>
</html>